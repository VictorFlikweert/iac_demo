services:
  salt-master:
    image: saltstack/salt:3006.4
    command: salt-master -l info
    volumes:
      - ./saltstack/master.d:/etc/salt/master.d
      - ./saltstack/states:/srv/salt
    ports:
      - "4505:4505"
      - "4506:4506"

  salt-minion-panelpc:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-panelpc.d:/etc/salt/minion.d
    hostname: minion-panelpc

  salt-minion-qg-1:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-qg-1.d:/etc/salt/minion.d
    hostname: minion-qg-1

  salt-minion-qg-2:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-qg-2.d:/etc/salt/minion.d
    hostname: minion-qg-2

  puppetserver:
    image: puppet/puppetserver:latest
    environment:
      - PUPPETSERVER_JAVA_ARGS=-Xms512m -Xmx512m
    volumes:
      - ./puppet/code:/etc/puppetlabs/code
      - ./puppet/server/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/autosign.conf:/etc/puppetlabs/puppet/autosign.conf
    ports:
      - "8140:8140"

  puppet-agent-panelpc:
    image: puppet/puppet-agent-ubuntu:latest
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-panelpc/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-panelpc/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: panelpc

  puppet-agent-qg-1:
    image: puppet/puppet-agent-ubuntu:latest
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-qg-1/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-qg-1/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: qg-1

  puppet-agent-qg-2:
    image: puppet/puppet-agent-ubuntu:latest
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-qg-2/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-qg-2/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: qg-2

  ansible-panelpc:
    build:
      context: ./ansible
      dockerfile: panelpc.Dockerfile
    command: sleep infinity
    environment:
      - ANSIBLE_CONFIG=/workspace/ansible.cfg
    volumes:
      - ./ansible:/workspace
    hostname: ansible-panelpc

  ansible-worker-qg-1:
    build:
      context: ./ansible
      dockerfile: worker.Dockerfile
    hostname: ansible-worker-qg-1

  ansible-worker-qg-2:
    build:
      context: ./ansible
      dockerfile: worker.Dockerfile
    hostname: ansible-worker-qg-2

  chef-panelpc:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-panelpc

  chef-qg-1:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-qg-1

  chef-qg-2:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-qg-2

  landscape-controller:
    build:
      context: ./landscape
      dockerfile: controller.Dockerfile
    hostname: landscape-controller
    volumes:
      - ./landscape/state:/workspace/state
      - ./landscape/controller:/workspace/controller
    ports:
      - "8028:8028"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8028/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5

  landscape-panelpc:
    build:
      context: ./landscape
      dockerfile: agent.Dockerfile
    depends_on:
      - landscape-controller
    environment:
      - LANDSCAPE_CONTROLLER=http://landscape-controller:8028
      - LANDSCAPE_NODE_NAME=landscape-panelpc
    volumes:
      - ./landscape/node-data/panelpc:/workspace/data
      - ./landscape/agent:/opt/landscape

  landscape-qg-1:
    build:
      context: ./landscape
      dockerfile: agent.Dockerfile
    depends_on:
      - landscape-controller
    environment:
      - LANDSCAPE_CONTROLLER=http://landscape-controller:8028
      - LANDSCAPE_NODE_NAME=landscape-qg-1
    volumes:
      - ./landscape/node-data/qg-1:/workspace/data
      - ./landscape/agent:/opt/landscape

  landscape-qg-2:
    build:
      context: ./landscape
      dockerfile: agent.Dockerfile
    depends_on:
      - landscape-controller
    environment:
      - LANDSCAPE_CONTROLLER=http://landscape-controller:8028
      - LANDSCAPE_NODE_NAME=landscape-qg-2
    volumes:
      - ./landscape/node-data/qg-2:/workspace/data
      - ./landscape/agent:/opt/landscape
