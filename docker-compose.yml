services:
  salt-master:
    image: saltstack/salt:3006.4
    command: salt-master -l info
    volumes:
      - ./saltstack/master.d:/etc/salt/master.d
      - ./saltstack/states:/srv/salt
    ports:
      - "4505:4505"
      - "4506:4506"

  salt-minion-panelpc:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-panelpc.d:/etc/salt/minion.d
    hostname: minion-panelpc

  salt-minion-qg-1:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-qg-1.d:/etc/salt/minion.d
    hostname: minion-qg-1

  salt-minion-qg-2:
    image: saltstack/salt:3006.4
    command: salt-minion -l info
    depends_on:
      - salt-master
    volumes:
      - ./saltstack/minion-qg-2.d:/etc/salt/minion.d
    hostname: minion-qg-2

  puppetserver:
    image: puppet/puppetserver:latest
    environment:
      - PUPPETSERVER_JAVA_ARGS=-Xms512m -Xmx512m
    volumes:
      - ./puppet/code:/etc/puppetlabs/code
      - ./puppet/server/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/autosign.conf:/etc/puppetlabs/puppet/autosign.conf
    ports:
      - "8140:8140"

  puppet-agent-panelpc:
    image: puppet/puppet-agent-ubuntu:jammy
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-panelpc/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-panelpc/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: panelpc

  puppet-agent-qg-1:
    image: puppet/puppet-agent-ubuntu:jammy
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-qg-1/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-qg-1/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: qg-1

  puppet-agent-qg-2:
    image: puppet/puppet-agent-ubuntu:jammy
    depends_on:
      - puppetserver
    volumes:
      - ./puppet/agent-qg-2/puppet.conf:/etc/puppetlabs/puppet/puppet.conf
      - ./puppet/agent-qg-2/ssl:/etc/puppetlabs/puppet/ssl
    entrypoint:
      - /bin/bash
      - -lc
      - |
        while true; do
          /opt/puppetlabs/bin/puppet agent --test --waitforcert 60 || true
          sleep 60
        done
    hostname: qg-2

  ansible-panelpc:
    build:
      context: ./ansible
      dockerfile: master.Dockerfile
    command: sleep infinity
    volumes:
      - ./ansible/inventory.ini:/etc/ansible/hosts
      - ./ansible/ssh:/etc/ssh
      - ./ansible/sshd_config:/etc/ssh/sshd_config
    hostname: ansible-panelpc
    networks:
      ansible_net:
        ipv4_address: 10.5.0.5

  ansible-qg-1:
    build:
      context: ./ansible
      dockerfile: worker.Dockerfile
    command: sleep infinity
    hostname: ansible-qg-1
    ports:
      - "2221:22"
    volumes:
      - ./ansible/ssh:/etc/ssh
      - ./ansible/sshd_config:/etc/ssh/sshd_config
    networks:
      ansible_net:
        ipv4_address: 10.5.0.6

  ansible-qg-2:
    build:
      context: ./ansible
      dockerfile: worker.Dockerfile
    command: sleep infinity
    hostname: ansible-qg-2
    ports:
      - "2222:22"
    volumes:
      - ./ansible/ssh:/etc/ssh
      - ./ansible/sshd_config:/etc/ssh/sshd_config
    networks:
      ansible_net:
        ipv4_address: 10.5.0.7

  chef-panelpc:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-panelpc

  chef-qg-1:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-qg-1

  chef-qg-2:
    image: chef/chefworkstation:latest
    command: sleep infinity
    environment:
      - CHEF_LICENSE=accept
    volumes:
      - ./chef:/workspace
    hostname: chef-qg-2

networks:
  ansible_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/16
          gateway: 10.5.0.1